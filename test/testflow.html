<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ğŸ® Cache-cache BLE</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0a0a0a;
  color: #eee;
  text-align: center;
}

button {
  padding: 10px 20px;
  font-size: 16px;
  margin: 10px;
}

#status {
  font-size: 1.2em;
  margin: 10px;
}

#radar {
  margin: 30px auto;
  width: 320px;
  height: 320px;
  border-radius: 50%;
  background:
    radial-gradient(circle,
      rgba(0,255,0,0.15) 0%,
      rgba(255,255,0,0.15) 40%,
      rgba(255,0,0,0.2) 70%,
      rgba(0,0,0,0.9) 100%);
  position: relative;
}

#dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  position: absolute;
}

#sweep {
  position: absolute;
  width: 50%;
  height: 2px;
  background: rgba(0,255,0,0.7);
  top: 50%;
  left: 50%;
  transform-origin: left center;
  animation: sweep 1.8s linear infinite;
}

@keyframes sweep {
  to { transform: rotate(360deg); }
}

.win {
  color: lime;
  font-size: 2em;
}
</style>
</head>

<body>

<h2>ğŸ® Cache-cache BLE</h2>
<button onclick="connect()">ğŸ” Chercher</button>

<div id="status">En attente...</div>

<div id="radar">
  <div id="sweep"></div>
  <div id="dot"></div>
</div>

<script>
let device;
let filteredRSSI = -100;
let beepTimer = null;
let winTimer = 0;

// ğŸ¯ RÃ©glages du jeu
const RSSI_MIN = -90;
const RSSI_MAX = -45;
const WIN_RSSI = -55;       // proche = gagnÃ©
const WIN_TIME = 1500;     // ms Ã  rester proche
const SMOOTHING = 0.25;

async function connect() {
  device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true
  });

  document.getElementById("status").innerText = "Recherche en coursâ€¦";

  await device.watchAdvertisements();
  device.addEventListener("advertisementreceived", onAd);
}

function onAd(event) {
  const rssi = event.rssi;
  filteredRSSI += SMOOTHING * (rssi - filteredRSSI);

  updateGame(filteredRSSI);
}

// ğŸ® Logique du jeu
function updateGame(rssi) {
  const ratio = clamp((rssi - RSSI_MIN) / (RSSI_MAX - RSSI_MIN), 0, 1);
  const color = ratio > 0.7 ? "lime" : ratio > 0.4 ? "yellow" : "red";

  updateRadar(ratio, color);
  updateBeep(ratio);

  document.getElementById("status").innerHTML =
    `Signal: <span style="color:${color}">${rssi.toFixed(1)} dBm</span>`;

  // ğŸ† Condition de victoire
  if (rssi > WIN_RSSI) {
    winTimer += 100;
    if (winTimer >= WIN_TIME) {
      win();
    }
  } else {
    winTimer = 0;
  }
}

// ğŸŸ¢ Radar
function updateRadar(ratio, color) {
  const radius = 150 * (1 - ratio);
  const angle = Math.random() * Math.PI * 2;

  const x = 160 + radius * Math.cos(angle);
  const y = 160 + radius * Math.sin(angle);

  const dot = document.getElementById("dot");
  dot.style.left = `${x}px`;
  dot.style.top = `${y}px`;
  dot.style.background = color;
}

// ğŸ”Š Bip chaud / froid
function updateBeep(ratio) {
  if (ratio <= 0) {
    stopBeep();
    return;
  }

  const interval = 1800 - ratio * 1600;
  startBeep(interval);
}

function playBeep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.frequency.value = 900;
  gain.gain.value = 0.15;

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  osc.stop(ctx.currentTime + 0.06);
}

function startBeep(interval) {
  if (beepTimer) return;
  beepTimer = setInterval(playBeep, interval);
}

function stopBeep() {
  clearInterval(beepTimer);
  beepTimer = null;
}

// ğŸ† Victoire
function win() {
  stopBeep();
  document.getElementById("status").innerHTML =
    "<span class='win'>ğŸ‰ TrouvÃ© ! ğŸ‰</span>";
  device.removeEventListener("advertisementreceived", onAd);
}

// ğŸ”§ Utils
function clamp(v, min, max) {
  return Math.min(Math.max(v, min), max);
}
</script>

</body>
</html>
